# @Author: archer
# @Date:   2019-09-13T12:52:06+01:00
# @Last modified by:   archer
# @Last modified time: 2020-03-10T00:23:07+00:00



# set environment variables using .env file located in this same directory
version: "3.7"

services:

  # by default uses local files and copies them into docker
  # if you prefer a more sable version swap the commented context call
  # with the uncommented one.
  nemesyst:
    build:
      # this is the stable/ longer term (ubuntu) version:
      # context: ./examples/containers/nemesyst_ubuntu
      # this is the archlinux on the edge version, it is very big (+10G):
      context: ./
      # just the name of the dockerfile we want to use, happens to be normal
      dockerfile: Dockerfile
    # giving our build image a name for future reference
    image: archer/nemesyst
    # giving out image which spawns from our image a name
    container_name: nemesyst_client
    # ensuring MongoDB is started before we start ours
    depends_on:
      - mongodb

  mongodb:
    container_name: mongodb_server
    # this is the official image name to use so we dont have to create one
    image: "mongo"
    ports:
      # this maps one of our local ports to one of the containers ones
      # "local-port:container-port":
      - "127.0.0.1:65530:27017"
      # this will expose the database to everybody by piping all trafic
      # to host-port:container-port, even external machines and traffic:
      # - "65530:27017"
    command:
      - "--config"
      - "/etc/mongodb.conf" # this is the in container path
      # be warned our config file uses additional options like directoryPerDB
      # which may make it not work with existing databases, if in doubt just
      # use your own config file and change the volume path below
    volumes:
      # this is the location to mount in container and storage for db
      # "volume-name:in-container mount point (not local system):"
      # or /local/location:/docker/location
      # - "mongodb-volume:/data/db"
      - /containers/mongodb:/data/db
      # local file:docker vm location # this copies over the config file
      # This will copy local config file to docker container
      # - /etc/mongodb.conf:/etc/mongodb.conf
      - ./examples/configs/mongo/mongo_docker.yaml:/etc/mongodb.conf

  nginx:
    container_name: nginx_proxy
    image: "nginx:mainline-alpine"
    ports:
      - "65535:27017" # the first port here is accessible from anywhere
    volumes:
      # storage directory for logs etc
      - /containers/nginx:/nginx
      # volume to store the nginx config
      - ./examples/configs/nginx/nginx.conf:/etc/nginx/nginx.conf
