# quick python file to wrangle movieLense data set
import pandas as pd
import os

cwd = os.getcwd()
print(cwd)

# import ratings (most important)
filePathRatings = '../../DataSets/ml-20m/ratings.csv'
ratings = pd.read_csv(filePathRatings)

# import tags of movies
filePathTags = '../../DataSets/ml-20m/tags.csv'
tags = pd.read_csv(filePathTags)

# import tag relevance scores
filePathTagRelevance = '../../DataSets/ml-20m/genome-scores.csv'
tagRelevance = pd.read_csv(filePathTagRelevance)

# import tagId to tagName relationship
filePathTagName = '../../DataSets/ml-20m/genome-tags.csv'
tagName = pd.read_csv(filePathTagName)

# import movie names
filePathMovieName = '../../DataSets/ml-20m/movies.csv'
movieName = pd.read_csv(filePathMovieName)

# merge seperate frames into tags associated to movies
movieTags = pd.merge(tagRelevance, tagName)
# merge tags with movies and genres
movieMetaData = pd.merge(movieTags, movieName)

movieMetaData.sort_values(['movieId', 'relevance'], ascending=[True, False], inplace=True)
#topXTags = movieMetaData.groupby('movieId')['relevance'].nlargest(5)
topXTags = movieMetaData.groupby('movieId').head(10)
#test = movieMetaData.groupby('movieId', 'relevance').nlargest(5)#[:].nlargest(5, 'relevance')
#test = movieMetaData.groupby('movieId')
userAvgRating = ratings.groupby('userId')['rating'].mean()


# check if users line up
numUsers = len(set(ratings['userId']))
numUserRatings = len(userAvgRating)
lastUserId = (ratings.tail(1).iloc[0])[0]
listUniqueUsers = list(ratings['userId'].unique())

# check if movies line up first reorder the list
ratings.sort_values(['movieId', 'userId'], ascending=[True, False], inplace=True) # this changes order for movies so cannot recombine
movieAvgRating = ratings.groupby('movieId')['rating'].mean()
numMovies = len(set(ratings['movieId']))
numMovieRatings = len(movieAvgRating)
lastMovieId = (ratings.tail(1).iloc[0])[1] #fek
listUniqueMovies = list(ratings['movieId'].unique())

# user avg ratings as data frame
userAvgRatingWithId = pd.DataFrame()
userAvgRatingWithId['userAvgRating'] = userAvgRating
userAvgRatingWithId['userId'] = listUniqueUsers

# movie avg ratings as data frame
movieAvgRatingWithId = pd.DataFrame()
movieAvgRatingWithId['movieAvgRating'] = movieAvgRating
movieAvgRatingWithId['movieId'] = listUniqueMovies

ratings = pd.merge(ratings, movieAvgRatingWithId)
ratings = pd.merge(ratings, userAvgRatingWithId)

ratings.sort_values(['movieId', 'userId'], ascending=[True, True], inplace=True)
#rating_tags = pd.merge(ratings, tags)

# exporting datasets
#ratings.to_csv('pythonRatings', encoding='utf-8', index=False)
#movieMetaData.to_csv('pythonMovieMetaData', encoding='utf-8', index=False)

print('you smell')